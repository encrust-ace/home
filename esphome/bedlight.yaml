globals:
  - id: palette_colors
    type: std::vector<Color>
    restore_value: false

esphome:
  name: bed
  friendly_name: "Bed"
  on_boot:
    priority: -100
    then:
      - lambda: |-
          if (id(palette_colors).empty()) {
            id(palette_colors).push_back(Color(255,116,0,0));
            id(palette_colors).push_back(Color(255,180,60,0));
            id(palette_colors).push_back(Color(255,255,200,0));
          }

esp8266:
  board: nodemcuv2
  restore_from_flash: true

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  min_auth_mode: WPA2
  power_save_mode: NONE
  ap:
    ssid: "Bed"
    password: "12345678"

logger:
  level: INFO
api:
ota:
  - platform: esphome
captive_portal:
web_server:
debug:

# ========== SENSORS ==========

sensor:
  - platform: wifi_signal
    name: "WiFi Signal (dBm)"
    id: wifi_signal_db
    update_interval: 60s
    entity_category: "diagnostic"

  - platform: uptime
    name: "Uptime"
    unit_of_measurement: "s"
    entity_category: "diagnostic"

  - platform: debug
    free:
      name: "Heap Free"

text_sensor:
  - platform: wifi_info
    ssid:
      name: "Connected SSID"
      icon: "mdi:wifi"
      entity_category: "diagnostic"

# ========== PALETTE INPUT ==========

text:
  - platform: template
    name: "Palette"
    id: custom_palette
    optimistic: true
    mode: text
    initial_value: "255,116,0,0;255,180,60,0;255,255,200,0"
    on_value:
      then:
        - lambda: |-
            std::vector<Color> parsed;
            int r, g, b, w;
            const char *s = x.c_str();
            bool invalid = false;

            while (*s) {
              if (sscanf(s, "%d,%d,%d,%d", &r, &g, &b, &w) == 4) {
                if (r<0||r>255||g<0||g>255||b<0||b>255||w<0||w>255) {
                  invalid = true;
                  break;
                }
                parsed.push_back(Color(r, g, b, w));
              } else {
                invalid = true;
                break;
              }

              s = strchr(s, ';');
              if (!s) break;
              s++;
            }

            if (!invalid && parsed.size() >= 2) {
              id(palette_colors) = parsed;
            }


# ========== LIGHTS ==========
number:
  - platform: template
    name: "Effect Speed" 
    id: effect_speed
    optimistic: true
    min_value: 0
    max_value: 50
    step: 1
    initial_value: 10
    entity_category: "config"

light:
  # 1. MASTER PHYSICAL LIGHT
  - platform: neopixelbus
    variant: ws2811
    type: BRG
    pin: GPIO04
    num_leds: 54
    id: strip_light
    name: "Light"
    restore_mode: RESTORE_DEFAULT_OFF
    default_transition_length: 0s
    effects:
      - random:
      - !include custom-effects/gradient.yaml
      - !include custom-effects/lightning.yaml